<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.plantopia.dao.PlantMapper">
	<resultMap id="plantResultMap" type="com.plantopia.dto.PlantDto">
        <id property="pla_idx" column="pla_idx" />
        <result property="pla_title" column="pla_title" />
        <result property="pla_contents" column="pla_contents" />
        <result property="pla_img" column="pla_img" />
        <result property="pla_date" column="pla_date" />
        <result property="pla_hit_cnt" column="pla_hit_cnt" />
        <result property="user_num" column="user_num" />
        <result property="writer" column="writer" />
        <result property="likeCount"  column="like_cnt"/>
    </resultMap>

	<!-- 게시글 목록 조회 (기본 목록 조회) -->
	<select id="selectPlantList" resultMap="plantResultMap">
	    SELECT 
	        p.pla_idx,
	        p.pla_title,
	        p.pla_contents,
	        p.pla_img,
	        p.pla_date,
	        p.pla_hit_cnt,
	        p.user_num, 
	        u.user_nickname AS writer
	    FROM Plant p
	    JOIN User u ON p.user_num = u.user_num
	    ORDER BY p.pla_idx DESC
	</select>


	<!-- 게시글 목록 조회 (페이징 처리된) -->
    <select id="selectPlantPaging" resultMap="plantResultMap">
        SELECT 
            p.pla_idx,
            p.pla_title,
            p.pla_contents,
        	p.pla_img, 
            p.pla_date,
            p.pla_hit_cnt,
            p.user_num, 
            u.user_nickname AS writer
        FROM Plant p
        JOIN User u ON p.user_num = u.user_num
        ORDER BY p.pla_idx DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- 전체 게시글 수 조회 -->
    <select id="getTotalPlantCount" resultType="int">
        SELECT COUNT(*) FROM Plant
    </select>

	<!-- 게시글 등록 -->
	<insert id="insertPlant" parameterType="com.plantopia.dto.PlantDto">
		insert into Plant (pla_title, pla_contents, pla_img, pla_date, user_num)
		 values (#{pla_title}, #{pla_contents}, #{pla_img}, NOW(), #{user_num})
	</insert>

	<!-- 조회수 증가 -->
	<update id="updateHitCount" parameterType="int">
		update Plant set pla_hit_cnt = pla_hit_cnt + 1 where pla_idx = #{plaIdx}
	</update>

	<!-- 게시글 상세 조회 -->
	<select id="selectPlantDetail" parameterType="int" resultMap="plantResultMap">
		select p.pla_idx, p.pla_title, p.pla_contents,
		  p.pla_img, p.pla_date, p.pla_hit_cnt, p.user_num,
		   u.user_nickname as writer
			from Plant p join User u on p.user_num = u.user_num
 			 where p.pla_idx = #{pla_idx}
	</select>

	<!-- 게시글 수정 -->
	<update id="updatePlant">
		update Plant
		set pla_title = #{pla_title},
		    pla_contents = #{pla_contents},
		    pla_img = #{pla_img},
		    pla_date = NOW() where pla_idx = #{pla_idx}
	</update>

	<!-- 게시글 삭제 -->
	<delete id="deletePlant">
		delete from Plant where pla_idx = #{pla_idx}
	</delete>
	
	<!-- (추가) 사용자별 글 목록 -->
	<select id="selectPlantByUser" resultMap="plantResultMap" parameterType="int">
	    select
	    	p.pla_idx,
	    	p.pla_title,
	    	p.pla_contents,
	    	p.pla_img,
	    	p.pla_date,
	    	p.pla_hit_cnt,
	    	p.user_num,
	    	u.user_nickname AS writer
	    from Plant p
	    join User u on p.user_num = u.user_num
	    where p.user_num = #{user_num}
	    order by p.pla_idx DESC
	</select>
	
	<!-- 인기글 조회: 조회수 + 좋아요수 합산하여 내림차순, 상위 8개 -->
  <select id="selectPopularPlants" resultMap="plantResultMap">
    SELECT
      p.pla_idx,
      p.pla_title,
      p.pla_contents,
      p.pla_img,
      p.pla_date,
      p.pla_hit_cnt,
      p.user_num,
      u.user_nickname AS writer,
      COALESCE(l.like_cnt,0) AS like_cnt
    FROM Plant p
    JOIN User u
      ON p.user_num = u.user_num
    LEFT JOIN (
      SELECT pla_idx, COUNT(*) AS like_cnt
      FROM PostLike
      GROUP BY pla_idx
    ) l ON p.pla_idx = l.pla_idx
    ORDER BY (p.pla_hit_cnt + COALESCE(l.like_cnt,0)) DESC
    LIMIT 8
  </select>
  
  <!-- 프로필 페이지 페이징 용 코드 -->
  <select id="selectPlantByUserPaging" resultMap="plantResultMap" parameterType="map">
	  SELECT p.*, u.user_nickname AS writer
	    FROM Plant p
	    JOIN User u ON p.user_num = u.user_num
	   WHERE p.user_num = #{userNum}
	   ORDER BY p.pla_date DESC
	   LIMIT #{offset}, #{pageSize}
  </select>
  <select id="countByUser" resultType="int" parameterType="int">
	   SELECT COUNT(*) FROM Plant WHERE user_num = #{userNum}
  </select>
  
    <!-- 제목으로 검색 -->
	<select id="selectPlantListBySearch" resultMap="plantResultMap">
	    SELECT 
	        p.pla_idx,
	        p.pla_title,
	        p.pla_contents,
	        p.pla_img,
	        p.pla_date,
	        p.pla_hit_cnt,
	        p.user_num, 
	        u.user_nickname AS writer
	    FROM Plant p
	    JOIN User u ON p.user_num = u.user_num
	    WHERE p.pla_title LIKE CONCAT('%', #{search}, '%')  <!-- 제목에서 검색어가 포함된 게시글을 찾음 -->
	    ORDER BY p.pla_idx DESC
	    LIMIT #{limit} OFFSET #{offset}
	</select>
	
	<!-- 제목으로 검색한 게시글 수 조회 -->
	<select id="getTotalPlantCountBySearch" resultType="int">
	    SELECT COUNT(*) 
	    FROM Plant p
	    WHERE p.pla_title LIKE CONCAT('%', #{search}, '%')  <!-- 제목에서 검색어가 포함된 게시글의 개수 조회 -->
	</select>
  
  
</mapper>        
        